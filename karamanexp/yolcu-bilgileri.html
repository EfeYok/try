<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karaman Express - Yolcu Bilgileri</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 via-blue-600 to-blue-400">
    <!-- Header -->
    <div class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <button onclick="window.location.href='koltuk-secimi.html'" class="flex items-center gap-3 hover:opacity-80 transition">
                    <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-800">Karaman Express</h1>
                </button>
                <div class="text-sm text-gray-600">
                    ğŸ“ 0850 123 45 67
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="bg-white/10 backdrop-blur-sm border-b border-white/20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-center gap-2">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <span class="text-white text-sm font-medium hidden sm:inline">GÃ¼zergah</span>
                </div>
                <div class="w-12 h-1 bg-green-500"></div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <span class="text-white text-sm font-medium hidden sm:inline">Sefer</span>
                </div>
                <div class="w-12 h-1 bg-green-500"></div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <span class="text-white text-sm font-medium hidden sm:inline">Koltuk</span>
                </div>
                <div class="w-12 h-1 bg-blue-400"></div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-400 text-white flex items-center justify-center font-bold text-sm">4</div>
                    <span class="text-white text-sm font-medium hidden sm:inline">Bilgiler</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-5xl mx-auto">
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Sol Panel: Form -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Yolcu Bilgileri -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Yolcu Bilgileri
                        </h2>
                        
                        <form id="passenger-form" class="space-y-4">
                            <!-- Ad Soyad -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Ad Soyad <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="fullname" 
                                    required 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-gray-800 transition"
                                    placeholder="AdÄ±nÄ±z ve SoyadÄ±nÄ±z"
                                >
                                <p class="text-xs text-gray-500 mt-1">KimliÄŸinizdeki isim ile aynÄ± olmalÄ±dÄ±r</p>
                            </div>

                            <!-- TC Kimlik No -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    TC Kimlik No <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="tcno" 
                                    required 
                                    maxlength="11" 
                                    pattern="[0-9]{11}"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-gray-800 transition"
                                    placeholder="12345678901"
                                >
                                <p class="text-xs text-gray-500 mt-1">11 haneli TC Kimlik numaranÄ±z</p>
                            </div>

                            <!-- Telefon -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Telefon <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="tel" 
                                    id="phone" 
                                    required
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-gray-800 transition"
                                    placeholder="0555 555 55 55"
                                >
                                <p class="text-xs text-gray-500 mt-1">Biletiniz SMS ile gÃ¶nderilecektir</p>
                            </div>

                            <!-- E-posta -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    E-posta <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    required
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-gray-800 transition"
                                    placeholder="ornek@email.com"
                                >
                                <p class="text-xs text-gray-500 mt-1">Biletiniz e-posta ile gÃ¶nderilecektir</p>
                            </div>

                            <!-- Cinsiyet (Read-only) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Cinsiyet
                                </label>
                                <input 
                                    type="text" 
                                    id="gender" 
                                    readonly
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed"
                                >
                            </div>
                        </form>
                    </div>

                    <!-- SÃ¶zleÅŸme ve Onay -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">SÃ¶zleÅŸme ve Onay</h3>
                        <div class="space-y-3">
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" id="terms-check" class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-600">
                                <span class="text-sm text-gray-700 group-hover:text-gray-900">
                                    <a href="#" class="text-blue-600 hover:underline font-semibold">Mesafeli SatÄ±ÅŸ SÃ¶zleÅŸmesi</a>'ni ve 
                                    <a href="#" class="text-blue-600 hover:underline font-semibold">KiÅŸisel Verilerin KorunmasÄ±</a> hakkÄ±ndaki metni okudum, kabul ediyorum.
                                </span>
                            </label>
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="checkbox" id="kvkk-check" class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-600">
                                <span class="text-sm text-gray-700 group-hover:text-gray-900">
                                    Karaman Express'ten kampanya, yenilik ve fÄ±rsatlardan haberdar olmak istiyorum.
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- SaÄŸ Panel: Ã–zet -->
                <div class="space-y-6">
                    <!-- Seyahat Ã–zeti -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Seyahat Ã–zeti
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- GÃ¼zergah -->
                            <div class="pb-4 border-b border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-lg font-bold text-gray-800" id="summary-from"></span>
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                    <span class="text-lg font-bold text-gray-800" id="summary-to"></span>
                                </div>
                                <div class="text-sm text-gray-600" id="summary-distance"></div>
                            </div>

                            <!-- Tarih ve Saat -->
                            <div class="grid grid-cols-2 gap-4 pb-4 border-b border-gray-200">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">Tarih</div>
                                    <div class="text-sm font-semibold text-gray-800" id="summary-date"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">KalkÄ±ÅŸ Saati</div>
                                    <div class="text-sm font-semibold text-gray-800" id="summary-time"></div>
                                </div>
                            </div>

                            <!-- Koltuk ve OtobÃ¼s -->
                            <div class="grid grid-cols-2 gap-4 pb-4 border-b border-gray-200">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">Koltuk No</div>
                                    <div class="text-2xl font-bold text-blue-600" id="summary-seat"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">OtobÃ¼s Tipi</div>
                                    <div class="text-sm font-semibold text-gray-800" id="summary-bustype"></div>
                                </div>
                            </div>

                            <!-- Fiyat -->
                            <div class="pt-2">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-700">Bilet FiyatÄ±</span>
                                    <span class="text-lg font-bold text-gray-800" id="summary-price"></span>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t-2 border-gray-300">
                                    <span class="text-lg font-bold text-gray-800">Toplam</span>
                                    <span class="text-3xl font-bold text-green-600" id="summary-total"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ã–deme Butonu -->
                    <button 
                        onclick="completeBooking()" 
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Rezervasyonu Tamamla
                    </button>

                    <!-- GÃ¼venli Ã–deme -->
                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            <div>
                                <div class="font-bold text-green-800 text-sm mb-1">GÃ¼venli Rezervasyon</div>
                                <div class="text-xs text-green-700">Bilgileriniz 256-bit SSL sertifikasÄ± ile korunmaktadÄ±r.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            // Firebase Console'dan aldÄ±ÄŸÄ±nÄ±z config buraya gelecek (index.html ile aynÄ±)
            apiKey: "AIzaSyD7hCepYSGIR9WPbTQQ9UhivBQr9IxQFfc",
            authDomain: "karaman-express.firebaseapp.com",
            projectId: "karaman-express",
            storageBucket: "karaman-express.firebasestorage.app",
            messagingSenderId: "675458442911",
            appId: "1:675458442911:web:ca7d007b71649d0da864aa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firestoreModules = { collection, addDoc, serverTimestamp };
    </script>

    <script>
        const tripData = JSON.parse(localStorage.getItem('selectedTrip'));
        const seatData = JSON.parse(localStorage.getItem('selectedSeatData'));

        if (!tripData || !seatData) {
            window.location.href = 'index.html';
        }

        // Ã–zet bilgilerini doldur
        document.getElementById('summary-from').textContent = tripData.from;
        document.getElementById('summary-to').textContent = tripData.to;
        document.getElementById('summary-distance').textContent = `${tripData.distance} â€¢ ${tripData.duration}`;
        document.getElementById('summary-date').textContent = tripData.date.formatted.split(',')[0];
        document.getElementById('summary-time').textContent = tripData.time;
        document.getElementById('summary-seat').textContent = seatData.seatNumber;
        document.getElementById('summary-bustype').textContent = tripData.busType;
        document.getElementById('summary-price').textContent = tripData.price + ' â‚º';
        document.getElementById('summary-total').textContent = tripData.price + ' â‚º';
        document.getElementById('gender').value = seatData.gender;

        // Telefon formatÄ±
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length >= 4) {
                value = value.slice(0, 4) + ' ' + value.slice(4);
            }
            if (value.length >= 8) {
                value = value.slice(0, 8) + ' ' + value.slice(8);
            }
            if (value.length >= 11) {
                value = value.slice(0, 11) + ' ' + value.slice(11);
            }
            
            e.target.value = value.trim();
        });

        // TC Kimlik sadece rakam
        document.getElementById('tcno').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        async function completeBooking() {
            const fullname = document.getElementById('fullname').value.trim();
            const tcno = document.getElementById('tcno').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const termsCheck = document.getElementById('terms-check').checked;

            // BoÅŸ alan kontrolÃ¼
            if (!fullname || !tcno || !phone || !email) {
                alert('âš ï¸ LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurunuz!');
                return;
            }

            // Ad Soyad kontrolÃ¼
            const nameParts = fullname.split(' ').filter(part => part.length > 0);
            if (nameParts.length < 2) {
                alert('âš ï¸ LÃ¼tfen adÄ±nÄ±zÄ± ve soyadÄ±nÄ±zÄ± giriniz!');
                return;
            }
            if (!/^[a-zA-ZÄŸÃ¼ÅŸÄ±Ã¶Ã§ÄÃœÅÄ°Ã–Ã‡\s]+$/.test(fullname)) {
                alert('âš ï¸ Ad Soyad sadece harf iÃ§ermelidir!');
                return;
            }

            // TC Kimlik kontrolÃ¼
            if (tcno.length !== 11 || !/^\d+$/.test(tcno)) {
                alert('âš ï¸ TC Kimlik No 11 haneli rakamlardan oluÅŸmalÄ±dÄ±r!');
                return;
            }
            if (tcno[0] === '0') {
                alert('âš ï¸ TC Kimlik No 0 ile baÅŸlayamaz!');
                return;
            }

            // E-posta kontrolÃ¼
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('âš ï¸ GeÃ§erli bir e-posta adresi giriniz!');
                return;
            }

            // Telefon kontrolÃ¼
            const phoneClean = phone.replace(/\s/g, '');
            if (phoneClean.length < 10 || phoneClean.length > 11) {
                alert('âš ï¸ GeÃ§erli bir telefon numarasÄ± giriniz!\nÃ–rnek: 0555 555 55 55');
                return;
            }
            if (!/^0[1-9]\d{9}$/.test(phoneClean)) {
                alert('âš ï¸ GeÃ§erli bir TÃ¼rkiye telefon numarasÄ± giriniz!');
                return;
            }

            // SÃ¶zleÅŸme kontrolÃ¼
            if (!termsCheck) {
                alert('âš ï¸ Devam etmek iÃ§in sÃ¶zleÅŸmeleri kabul etmelisiniz!');
                return;
            }

            // Firebase'e kaydet
            try {
                console.log('ğŸ” Firebase baÄŸlantÄ±sÄ± kontrol ediliyor...');
                
                // Firebase modÃ¼llerini bekle
                let attempts = 0;
                while (!window.firestoreModules && attempts < 20) {
                    console.log('â³ Firebase yÃ¼kleniyor... (' + (attempts + 1) + '/20)');
                    await new Promise(resolve => setTimeout(resolve, 300));
                    attempts++;
                }

                if (!window.firestoreModules) {
                    console.error('âŒ Firebase modÃ¼lleri yÃ¼klenemedi!');
                    alert('âš ï¸ VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±. Rezervasyon kaydedilemedi.\n\nYine de devam etmek ister misiniz?');
                    // Yine de devam et
                    const passengerInfo = {
                        fullname: fullname,
                        tcno: tcno,
                        phone: phone,
                        email: email,
                        gender: seatData.gender
                    };
                    localStorage.setItem('passengerInfo', JSON.stringify(passengerInfo));
                    window.location.href = 'rezervasyon-onay.html';
                    return;
                }

                if (!window.db) {
                    console.error('âŒ Firebase database baÄŸlantÄ±sÄ± yok!');
                    alert('âš ï¸ VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±.');
                    return;
                }

                console.log('âœ… Firebase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!');

                const { collection, addDoc, serverTimestamp } = window.firestoreModules;

                // Rezervasyon verisi
                const reservationData = {
                    // Sefer bilgileri
                    from: tripData.from,
                    to: tripData.to,
                    date: tripData.date.date,
                    time: tripData.time,
                    busType: tripData.busType,
                    
                    // Koltuk bilgisi
                    seatNumber: parseInt(seatData.seatNumber), // Number olarak kaydet
                    
                    // Yolcu bilgileri
                    fullname: fullname,
                    tcno: tcno,
                    phone: phone,
                    email: email,
                    gender: seatData.gender,
                    
                    // Fiyat
                    price: tripData.price,
                    
                    // Duraklar (varsa)
                    stops: tripData.stops || [],
                    
                    // Zaman damgasÄ±
                    createdAt: serverTimestamp(),
                    
                    // PNR kodu
                    pnr: 'KE' + Date.now().toString().slice(-8)
                };

                console.log('ğŸ’¾ Firebase\'e kaydediliyor:', reservationData);

                // Firestore'a kaydet
                const docRef = await addDoc(collection(window.db, 'reservations'), reservationData);
                
                console.log('âœ… Rezervasyon baÅŸarÄ±yla kaydedildi!');
                console.log('ğŸ“„ Document ID:', docRef.id);
                console.log('ğŸ« PNR Kodu:', reservationData.pnr);

                // Yolcu bilgilerini localStorage'a kaydet (onay sayfasÄ± iÃ§in)
                const passengerInfo = {
                    fullname: fullname,
                    tcno: tcno,
                    phone: phone,
                    email: email,
                    gender: seatData.gender
                };

                localStorage.setItem('passengerInfo', JSON.stringify(passengerInfo));
                
                // BaÅŸarÄ±lÄ± rezervasyon sayfasÄ±na yÃ¶nlendir
                console.log('âœ… Onay sayfasÄ±na yÃ¶nlendiriliyor...');
                window.location.href = 'rezervasyon-onay.html';

            } catch (error) {
                console.error('âŒ Firebase kayÄ±t hatasÄ±:', error);
                console.error('Hata kodu:', error.code);
                console.error('Hata mesajÄ±:', error.message);
                console.error('Hata detaylarÄ±:', error);
                
                let errorMessage = 'Rezervasyon kaydedilirken bir hata oluÅŸtu:\n\n';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'ğŸ”’ Yetki hatasÄ±: Firebase Rules ayarlarÄ±nÄ± kontrol edin.\nRules sekmesinde "allow read, write: if true;" olmalÄ±.';
                } else if (error.code === 'unavailable') {
                    errorMessage += 'ğŸŒ BaÄŸlantÄ± hatasÄ±: Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.';
                } else if (error.code === 'failed-precondition') {
                    errorMessage += 'âš™ï¸ Firebase Firestore Database oluÅŸturulmamÄ±ÅŸ.';
                } else {
                    errorMessage += error.message;
                }
                
                alert('âš ï¸ ' + errorMessage);
            }
        }
    </script>
</body>
</html>